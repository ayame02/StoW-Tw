<!DOCTYPE html>
<html lang="en">

<head>
    <title>Stories on the web</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="styles.css">
    <style type="text/css">
        #textBox {
          width: 540px;
          height: 200px;
          border: 1px #000000 solid;
          padding: 12px;
          overflow: scroll;
        }
        #textBox #sourceText {
          padding: 0;
          margin: 0;
          min-width: 498px;
          min-height: 200px;
        }
    </style>
</head>

<body>
    <img src="images/logo.png" class="logo">
    <div class="upper_menu">
        <a href="loggedIn.html">Home</a>
        <a href="profile.php">Profile</a>
    </div>
    <div class="sidenav">
        
    </div>
    <form action="search.php" method="POST" class = "search-container">
        <input type="text" placeholder="Search" name = "search_text">
        <button class = "search-container-image" type="submit"><img src = "images/search_btn.png"></button>
    </form>
    <div class = "notification" id = "notif_me">
        
    </div>
    <section class="site_content2">
        <div id = "u_story">

        </div>
        <section class = "modifier" >
            <div id="textBox" contenteditable="true"><p id = "modif">
            
            </p></div>
            <p id = "send_story"> </p>
        </section>
        
    </section>
</body>

</html>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>
    var text_to_send = "";
    function dissapear(){
        document.getElementById("notif_me").style.visibility = "hidden";
    }

    function deletef(sid){
        var ajax = new XMLHttpRequest();
        $.ajax({
            url: "delete.php",
            type: "get",
            data: {
                story_id: sid
            },
            success: function(response){
                var html = "<p class = " + "story_title" + " style = " + "float:left" + ">" + response + "</p>";
                html += "<button onclick = " + "dissapear()" + ">Ok</button>";
                document.getElementById("notif_me").innerHTML = html;
                document.getElementById("notif_me").style.visibility = "visible";
                $("div").show();
                $("p").show();
                $("button").show();
            }
        })
    }

    function readTextFile(file){
        var rawFile = new XMLHttpRequest();
        rawFile.open("GET", file, true);
        rawFile.onreadystatechange = function ()
        {
            if(rawFile.readyState === 4)
            {
                if(rawFile.status === 200 || rawFile.status == 0)
                {
                    var allText = rawFile.responseText;
                    var html = "<p id = " + "change" + ">" + allText + "</p>";
                    document.getElementById("modif").innerHTML = html;
                    
                }
            }
        }
        rawFile.send(null);
    }

    function modif_story(sid){
        text_to_send = document.getElementById("modif").innerText;
        var ajax = new XMLHttpRequest();
        $.ajax({
            url: "modify_text.php",
            type: "get",
            data: {
                story_id: sid,
                text: text_to_send
            },
            success: function(response){
                var html = "<p class = " + "story_title" + " style = " + "float:left" + ">" + response + "</p>";
                html += "<button onclick = " + "dissapear()" + ">Ok</button>";
                document.getElementById("notif_me").innerHTML = html;
                document.getElementById("notif_me").style.visibility = "visible";
                $("div").show();
                $("p").show();
                $("button").show();
            }
        })
    }

    function editf(sid){
        var string = "/STOW/uploads/" + sid + ".txt";
        readTextFile(string);
        $("section").show();
        
        var html = "<input type=" + "submit" + " value=" + "Send" + " onclick =" + "modif_story(" + sid + ")" + " />";
        document.getElementById("send_story").innerHTML = html;
    }
    //call ajax
    var ajax = new XMLHttpRequest();
    var method = "GET";
    var url = "u_stories.php";
    var asyncronous = true;
    
    ajax.open(method, url, asyncronous);
    //sending ajax req
    ajax.send();
    
    //recv resp from u_stories.php
    ajax.onreadystatechange = function(){
        if(this.readyState == 4 && this.status == 200){
            var data = JSON.parse(this.responseText);
            console.log(data);
            var html = "<div>";
            var idx = 1;
            for (var a = 0; a < data.length; a++){
                var title = data[a].title;
                var story_image = data[a].story_image;
                var author = data[a].name;
                var desc = data[a].description;
                    
                html += "<div class=" + "story" + ">";
                    html += "<img src=" + story_image + " class=" + "story_image" + ">";
                    html += "<a href=" + title.replace(/\s/g, '') + ".html" + " class=" + "story_title" + ">" + idx + ". " + title + "</a>";
                    html += "<button onclick = " + "deletef(" + data[a].story_id + ")" + ">Delete</button>";
                        
                        
                    html += "<button onclick = " + "editf(" + data[a].story_id + ")" + ">Modify</button> </form>";
                        
                    html += "<p class=" + "story_author" + ">By " + author + "</p>";
                    if (desc) {
                        html += "<p class=" + "story_description" + ">" + desc + "</p>";
                    }
                html += "</div>";
                idx = idx + 1;
            }
            html += "</div>"
            document.getElementById("u_story").innerHTML = html;
        }
    }
</script>