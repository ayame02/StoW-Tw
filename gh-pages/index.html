<!DOCTYPE html>
<html lang="en">

<head>
    <title>Stories on the web</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <script type="text/javascript" src="calendar_desktop.js"></script>
    <script type="text/javascript" src="mobile_calendar.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>

<body onload="make_pages">
    <img src="images/logo.png" class="logo">
    <div class="upper_menu">
        <a href="login.html">Login</a>
        <a href="signUp.html">Sign up</a>
    </div>
    <div class="sidenav">
        <section>
            <p class="sidenav_bullet">Stories from around the world.</p>
            <?php
                    $dir = new DirectoryIterator("uploads/");
                    $servername = "localhost";
                    $username = "root";
                    $password = "-";
                    $databaseName = "tw";
				    $conn = new mysqli($servername, $username, $password, $databaseName);
                    foreach ($dir as $fileinfo) {
                        if (!$fileinfo->isDot()) {
                            $story = $fileinfo->getFilename();
                            $path_parts = pathinfo($story);
                            $name = (int)$path_parts['filename'];
                            $title = "";
                            $nickname = "";
                            $stmt = $conn->prepare("SELECT title, nickname FROM story WHERE story_id = ?;");
                            $res = $stmt->bind_param("i", $name);
                            $res = $stmt->execute();
                            $stmt->store_result();
                            $stmt->bind_result($title, $nickname);
                            $stmt->fetch();
                            $string = "<p class=";
                            $string1 = "stories";
                            $string2 = ">";
                            $string3 = "<a href=";
                            $string4 = ".html";
                            $string7 = ">";
                            $string5 = "</a>, uploaded by [";
                            $string6 = "]. </p>";
                            if ( $title !== '' and $nickname !== ''){
                                echo $string.$string1.$string2.$string3.$name.$string4.$string7.$title.$string5.$nickname.$string6;
                            }
                            $stmt->close();
                        }
                    }
                ?>
            
        </section>
        <br>
        <p class="sidenav_bullet"></p>
        <div id="calendar_desktop"></div>
        <div id="calendar_mobile">
            <p id="mobile_calendar-day"></p>
            <p id="mobile_calendar-date"></p>
            <p id="mobile_calendar-month-year"></p>
        </div>
    </div>
    <form action="search.php" method="POST" class = "search-container">
        <input type="text" placeholder="Search" name = "search_text">
        <button class = "search-container-image" type="submit"><img src = "images/search_btn.png"></button>
    </form>
    <section class="site_content">
            <div class="age_section">Ages 3-5</div>
            <div id = "age_35">
    
            </div>
            <div class="age_section">Ages 6-8 </div>
            <div id = "age_68">
                
            </div>
            <div class="age_section">Ages 9-15 </div>
            <div id = "age_914">
               
            </div>
            <div class="age_section">Ages 15+</div>
            <div id = "age_15">
                
            </div>
        </section>
</body>
    
</html>
<script>
    function make_pages(){
        var ajax = new XMLHttpRequest();
        ajax.open("GET", "make_pages.php", true);
        ajax.send();
        ajax.onreadystatechange = function(){
                if(this.readyState == 4 && this.status == 200){
                    var res = this.responseText;
                }
        }
    }
</script>
    
    <script>
            //call ajax
            var ajax = new XMLHttpRequest();
            var method = "GET";
            var url = "age_35.php";
            var asyncronous = true;
        
            ajax.open(method, url, asyncronous);
            //sending ajax req
            ajax.send();
        
            //recv resp from data.php
            ajax.onreadystatechange = function(){
                if(this.readyState == 4 && this.status == 200)
                {
                    var data = JSON.parse(this.responseText);
                    console.log(data);
                    var html = "<div>";
                    for (var a = 0; a < data.length; a++){
                        var title = data[a].title;
                        var story_image = data[a].story_image;
                        var author = data[a].name;
                        var desc = data[a].description;
        
                        html += "<div class=" + "story" + ">";
                            html += "<img src=" + story_image + " class=" + "story_image" + ">";
                            html += "<a href=" + title.replace(/\s/g, '') + ".html" + " class=" + "story_title" + ">" + title + "</a>";
                            html += "<p class=" + "story_author" + ">By " + author + "</p>";
                            if (desc) {
                                html += "<p class=" + "story_description" + ">" + desc + "</p>";
                            }
                        html += "</div>";
                    }
                    html += "</div>"
                    document.getElementById("age_35").innerHTML = html;
                }
            }
    </script>
    <script>
            //call ajax
            var ajax = new XMLHttpRequest();
            var method = "GET";
            var url = "age_68.php";
            var asyncronous = true;
        
            ajax.open(method, url, asyncronous);
            //sending ajax req
            ajax.send();
        
            //recv resp from data.php
            ajax.onreadystatechange = function(){
                if(this.readyState == 4 && this.status == 200)
                {
                    var data = JSON.parse(this.responseText);
                    console.log(data);
                    var html = "<div>";
                    for (var a = 0; a < data.length; a++){
                        var title = data[a].title;
                        var story_image = data[a].story_image;
                        var author = data[a].name;
                        var desc = data[a].description;
        
                        html += "<div class=" + "story" + ">";
                            html += "<img src=" + story_image + " class=" + "story_image" + ">";
                            html += "<a href=" + title.replace(/\s/g, '') + ".html" + " class=" + "story_title" + ">" + title + "</a>";
                            html += "<p class=" + "story_author" + ">By " + author + "</p>";
                            if (desc) {
                                html += "<p class=" + "story_description" + ">" + desc + "</p>";
                            }
                        html += "</div>";
                    }
                    html += "</div>"
                    document.getElementById("age_68").innerHTML = html;
                }
            }
    </script>
    <script>
            //call ajax
            var ajax = new XMLHttpRequest();
            var method = "GET";
            var url = "age_914.php";
            var asyncronous = true;
        
            ajax.open(method, url, asyncronous);
            //sending ajax req
            ajax.send();
        
            //recv resp from data.php
            ajax.onreadystatechange = function(){
                if(this.readyState == 4 && this.status == 200)
                {
                    var data = JSON.parse(this.responseText);
                    console.log(data);
                    var html = "<div>";
                    for (var a = 0; a < data.length; a++){
                        var title = data[a].title;
                        var story_image = data[a].story_image;
                        var author = data[a].name;
                        var desc = data[a].description;
        
                        html += "<div class=" + "story" + ">";
                            html += "<img src=" + story_image + " class=" + "story_image" + ">";
                            html += "<a href=" + title.replace(/\s/g, '') + ".html" + " class=" + "story_title" + ">" + title + "</a>";
                            html += "<p class=" + "story_author" + ">By " + author + "</p>";
                            if (desc) {
                                html += "<p class=" + "story_description" + ">" + desc + "</p>";
                            }
                        html += "</div>";
                    }
                    html += "</div>"
                    document.getElementById("age_914").innerHTML = html;
                }
            }
    </script>
    <script>
            //call ajax
            var ajax = new XMLHttpRequest();
            var method = "GET";
            var url = "age_15.php";
            var asyncronous = true;
        
            ajax.open(method, url, asyncronous);
            //sending ajax req
            ajax.send();
        
            //recv resp from data.php
            ajax.onreadystatechange = function(){
                if(this.readyState == 4 && this.status == 200)
                {
                    var data = JSON.parse(this.responseText);
                    console.log(data);
                    var html = "<div>";
                    for (var a = 0; a < data.length; a++){
                        var title = data[a].title;
                        var story_image = data[a].story_image;
                        var author = data[a].name;
                        var desc = data[a].description;
        
                        html += "<div class=" + "story" + ">";
                            html += "<img src=" + story_image + " class=" + "story_image" + ">";
                            html += "<a href=" + title.replace(/\s/g, '') + ".html" + " class=" + "story_title" + ">" + title + "</a>";
                            html += "<p class=" + "story_author" + ">By " + author + "</p>";
                            if (desc) {
                                html += "<p class=" + "story_description" + ">" + desc + "</p>";
                            }
                        html += "</div>";
                    }
                    html += "</div>"
                    document.getElementById("age_15").innerHTML = html;
                }
            }
    </script>